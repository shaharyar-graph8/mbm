name: Label

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request_target:
    types: [opened, labeled, unlabeled]

permissions:
  issues: write
  pull-requests: write

jobs:
  triage-label:
    runs-on: ubuntu-latest
    steps:
      - name: Add or remove needs-triage label
        uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const labels = item.labels.map(l => l.name);
            const hasTriageAccepted = labels.includes('triage-accepted');
            const hasNeedsTriage = labels.includes('needs-triage');

            if (!hasTriageAccepted && !hasNeedsTriage) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: ['needs-triage'],
              });
            } else if (hasTriageAccepted && hasNeedsTriage) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  name: 'needs-triage',
                });
              } catch (e) {
                if (e.status !== 404) throw e;
              }
            }

  kind-label:
    runs-on: ubuntu-latest
    steps:
      - name: Add or remove needs-kind label
        uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const labels = item.labels.map(l => l.name);
            const hasKind = labels.some(l => l.startsWith('kind/'));
            const hasNeedsKind = labels.includes('needs-kind');

            if (!hasKind && !hasNeedsKind) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: ['needs-kind'],
              });
            } else if (hasKind && hasNeedsKind) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  name: 'needs-kind',
                });
              } catch (e) {
                if (e.status !== 404) throw e;
              }
            }

  priority-label:
    runs-on: ubuntu-latest
    steps:
      - name: Add or remove needs-priority label
        uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const labels = item.labels.map(l => l.name);
            const hasPriority = labels.some(l => l.startsWith('priority/'));
            const hasNeedsPriority = labels.includes('needs-priority');

            if (!hasPriority && !hasNeedsPriority) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: ['needs-priority'],
              });
            } else if (hasPriority && hasNeedsPriority) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  name: 'needs-priority',
                });
              } catch (e) {
                if (e.status !== 404) throw e;
              }
            }

  actor-label:
    runs-on: ubuntu-latest
    steps:
      - name: Add or remove needs-actor label
        uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const labels = item.labels.map(l => l.name);
            const hasActor = labels.some(l => l.startsWith('actor/'));
            const hasNeedsActor = labels.includes('needs-actor');

            if (!hasActor && !hasNeedsActor) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: ['needs-actor'],
              });
            } else if (hasActor && hasNeedsActor) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  name: 'needs-actor',
                });
              } catch (e) {
                if (e.status !== 404) throw e;
              }
            }
