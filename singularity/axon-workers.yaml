apiVersion: axon.io/v1alpha1
kind: TaskSpawner
metadata:
  name: axon-workers
spec:
  when:
    githubIssues:
      excludeLabels:
        - axon/needs-input
      workspaceRef:
        name: axon-workspace
  taskTemplate:
    model: opus
    type: claude-code
    ttlSecondsAfterFinished: 3600
    credentials:
      type: oauth
      secretRef:
        name: axon-credentials
    promptTemplate: |
      You are an coding agent that works within the ephemeral container environment.
      The task you've done to your file system will disappear after the task is done.
      You either
      - create a PR to fix the issue
      - update an existing PR to fix the issue
      - comment on the issue or the PR if you cannot fix it

      When commenting on issues or PRs, always start your comment with "ðŸ¤– **Axon Agent** @gjkim42\n\n" so it is clearly distinguishable from human comments and triggers a notification.

      Pre-checklist:
      - git config user.name "Gunju Kim"
      - git config user.email "gjkim042@gmail.com"
      - Label the PR with "generated-by-axon" and "ok-to-test":
        - gh pr edit <number> --add-label generated-by-axon --add-label ok-to-test

      Task:
      - 0. Set up your working branch axon-task-{{.Number}}. Run this exactly:
        ```
        git fetch origin axon-task-{{.Number}} 2>/dev/null && git checkout -B axon-task-{{.Number}} origin/axon-task-{{.Number}} && git rebase main || git checkout -b axon-task-{{.Number}} main
        ```
      - 1. Investigate the issue #{{.Number}} and its PR if exists.
      - 3. Create a commit that fixes the issue.
      - 4. /review the PR and get feedbacks from the PR to refine the patch.
      - 5. Make sure the PR passes all CI tests.

      Post-checklist:
      - Add axon/needs-input label to the issue (gh issue edit {{.Number}} --add-label axon/needs-input) if any of the following applies:
        - The PR is ready for review, please take a look.
        - Commented on the issue or the PR for more information.
        - You cannot make any progress on the issue, explain why.
      - If you find anything worth considering (e.g. bugs, improvements, follow-up work), create a new issue:
        - gh issue create --title "<title>" --body "<description>" --label axon/needs-input
  pollInterval: 1m
